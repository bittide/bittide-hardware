# SPDX-FileCopyrightText: 2022 Google LLC
#
# SPDX-License-Identifier: Apache-2.0

name: CI

# XXX: What we'd really like is run on every pull request / pull request change,
#      which allows GitHub to cancel runs after (force) pushes. Triggering on
#      these seems to be broken since January 19th 2023 however. Note that not
#      everyone likes auto-cancellation so we should probably recognize [no-skip]
#      commits.
on:
  schedule:
    # UTC midnight. See the comment at 'branches-ignore' for more information on
    # our development flow. This job will run in context of the branch 'staging'.
    - cron:  '0 0 * * *'

  push:
      branches-ignore:
        # Developers request to merge their changes into 'staging'. In order to
        # do so, relatively cheap tests should pass CI. Every night, CI runs our
        # full test suite on 'staging'. If these pass, a pull request may be
        # created to get 'main' up to date with 'staging'. Note that this should
        # be automated in the future, but this will require some engineering.
        - 'staging'
        - 'main'

concurrency:
 group: ${{ github.head_ref || github.run_id }}
 cancel-in-progress: true

jobs:
  license-check:
    runs-on: self-hosted
    container:
      image: ubuntu:22.04
    steps:
    - uses: actions/checkout@v3
    - name: REUSE Compliance Check
      uses: fsfe/reuse-action@v1


  lint:
    name: Basic linting
    runs-on: self-hosted
    container:
      image: ubuntu:22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          .github/scripts/set_de_mirror.sh
          apt-get update
          apt-get install -y pcregrep

      - name: EOL whitespace
        run: |
          .github/scripts/check_eol_whitespace.sh

      - name: Enforce EOF newline
        run: |
          .github/scripts/check_missing_eof_newline.sh

  build:
    name: Build dependencies
    runs-on: self-hosted
    defaults:
      run:
        shell: git-nix-shell {0} --pure

    container:
      image: ghcr.io/clash-lang/nixos-bittide-hardware:2023-02-01

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set CI flags
        run: |
          cp .github/cabal.project.simulation cabal.project.local

      - name: Update Cabal index info
        run: |
          cabal update
          cabal freeze

      - name: Cache
        uses: actions/cache@v3
        with:
          path: |
            ~/.cabal-nix/store

          key: packages-cachebust-3-${{ hashFiles('cabal.project.freeze') }}
          restore-keys: packages-

      - name: Build
        run: |
          cabal build all --only-dependencies

  elastic-buffer-sim-topologies-matrix:
    name: elastic-buffer-sim-topologies simulation matrix generation
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Generate matrix
        run: |
          if [[ "${{ github.event_name }}" == "schedule" || $(.github/scripts/force_expensive_checks.sh) == "true" ]]; then
            cp .github/simulation/all.json sim.json
          else
            cp .github/simulation/staging.json sim.json
          fi

      - name: Set simulation matrix
        id: set-sim-matrix
        run: |
          echo "sim_matrix=$(cat sim.json | tr '\n' ' ')" | tee -a "$GITHUB_OUTPUT"

    outputs:
      sim_matrix: ${{ steps.set-sim-matrix.outputs.sim_matrix }}

  elastic-buffer-sim-topologies:
    name: Simulate network
    runs-on: self-hosted
    defaults:
      run:
        shell: git-nix-shell {0} --pure
    needs: [build, lint, elastic-buffer-sim-topologies-matrix]

    strategy:
      matrix:
        target: ${{ fromJson(needs.elastic-buffer-sim-topologies-matrix.outputs.sim_matrix) }}
      fail-fast: false

    container:
      image: ghcr.io/clash-lang/nixos-bittide-hardware:2023-02-01

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set CI flags
        run: |
          cp .github/cabal.project.simulation cabal.project.local

      - name: Update Cabal index info
        run: |
          cabal update
          cabal freeze

      - name: Cache
        uses: actions/cache@v3
        with:
          path: |
            ~/.cabal-nix/store

          key: packages-cachebust-3-${{ hashFiles('cabal.project.freeze') }}
          restore-keys: packages-cachebust-3-
          fail-on-cache-miss: true

      - name: Plot mesh grid
        run: |
          cabal run -- elastic-buffer-sim:sim \
            +RTS -M${{ matrix.target.hmem }}M -RTS \
            --output-mode pdf \
            --steps ${{ matrix.target.steps }} \
            --samples 1000 \
            --stop-when-stable \
            ${{ matrix.target.topology }} ${{ matrix.target.args }}

      - name: Upload plots
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: gen-plots-hs-${{ matrix.target.topology }}
          path: _build
          retention-days: 14

  elastic-buffer-sim-tests:
    name: elastic-buffer-sim unittests
    runs-on: self-hosted
    defaults:
      run:
        shell: git-nix-shell {0} --pure
    needs: [build, lint]

    container:
      image: ghcr.io/clash-lang/nixos-bittide-hardware:2023-02-01

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set CI flags
        run: |
          cp .github/cabal.project.simulation cabal.project.local

      - name: Update Cabal index info
        run: |
          cabal update
          cabal freeze

      - name: Cache
        uses: actions/cache@v3
        with:
          path: |
            ~/.cabal-nix/store

          key: packages-cachebust-3-${{ hashFiles('cabal.project.freeze') }}
          restore-keys: packages-cachebust-3-
          fail-on-cache-miss: true

      - name: Run unittests
        run: |
          cabal run elastic-buffer-sim:unittests


  contranomy-tests:
    name: Contranomy tests
    runs-on: self-hosted
    defaults:
      run:
        shell: git-nix-shell {0} --pure
    needs: [build, lint]

    container:
      image: ghcr.io/clash-lang/nixos-bittide-hardware:2023-02-01

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set CI flags
        run: |
          cp .github/cabal.project.simulation cabal.project.local

      - name: Update Cabal index info
        run: |
          cabal update
          cabal freeze

      - name: Cache
        uses: actions/cache@v3
        with:
          path: |
            ~/.cabal-nix/store

          key: packages-cachebust-3-${{ hashFiles('cabal.project.freeze') }}
          restore-keys: packages-cachebust-3-
          fail-on-cache-miss: true

      - name: Run unittests
        run: |
          cabal run contranomy:unittests


  contranomy-hdl:
    name: Generate Contranomy HDL
    runs-on: self-hosted
    defaults:
      run:
        shell: git-nix-shell {0} --keep GITHUB_OUTPUT --pure
    needs: [build, lint]

    container:
      image: ghcr.io/clash-lang/nixos-bittide-hardware:2023-02-01

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set CI flags
        run: |
          cp .github/cabal.project.formal cabal.project.local

      - name: Update Cabal index info
        run: |
          cabal update
          cabal freeze

      - name: Cache
        uses: actions/cache@v3
        with:
          path: |
            ~/.cabal-nix/store

          key: packages-cachebust-3-${{ hashFiles('cabal.project.freeze') }}
          restore-keys: packages-cachebust-3-
          fail-on-cache-miss: true

      - name: Build Contranomy
        run: |
          cabal run contranomy:clash -- --version
          cat dist-newstyle/cache/plan.json | python3 -m json.tool | grep -C 1 riscv-altopts

      - name: Generate HDL
        run: |
          cd contranomy
          cabal run -- contranomy:clash --verilog -main-is contranomyRVFITE Contranomy

      - name: Archive HDL
        run: |
          tar -c -f contranomy-hdl.tar contranomy/verilog

      - name: Upload Contranomy HDL
        uses: actions/upload-artifact@v3
        with:
          name: contranomy-hdl
          path: contranomy-hdl.tar

      - name: Get test matrix
        run: |
          echo '["formal-checks-disabled"]' > checks.json

      - name: Set test matrix
        id: set-matrix
        run: |
          echo "check_matrix=$(cat checks.json)" >> "$GITHUB_OUTPUT"

    outputs:
      check_matrix: ${{ steps.set-matrix.outputs.check_matrix }}

  contranomy-formal-tests:
    name: RISC-V Formal checks
    needs: contranomy-hdl

    runs-on: self-hosted
    defaults:
      run:
        shell: git-nix-shell {0} --pure

    container:
      image: ghcr.io/clash-lang/nixos-bittide-hardware:2023-02-01

    strategy:
      matrix:
        check: ${{ fromJson(needs.contranomy-hdl.outputs.check_matrix) }}
      fail-fast: false

    steps:
      - name: Checkout
        if: matrix.check != 'formal-checks-disabled'
        uses: actions/checkout@v3

      - name: Download Contranomy HDL
        if: matrix.check != 'formal-checks-disabled'
        uses: actions/download-artifact@v3
        with:
          name: contranomy-hdl

      - name: Extract HDL
        if: matrix.check != 'formal-checks-disabled'
        run: |
          tar -x -f contranomy-hdl.tar

      - name: Verify ${{ matrix.check }}
        if: matrix.check != 'formal-checks-disabled'
        run: |
          .github/scripts/run_riscv_formal_check.sh ${{ matrix.check }}

      - name: Verification failed, uploading results
        uses: actions/upload-artifact@v3
        if: failure()
        with:
          name: verify-${{ matrix.check }}-failed
          path: riscv-formal/cores/contranomy/checks/${{ matrix.check }}

  contranomy-sim-tests:
    name: ContranomySim tests and firmware integration tests
    runs-on: self-hosted
    defaults:
      run:
        shell: git-nix-shell {0} --pure
    needs: [build, lint, firmware-build-integration-tests]

    container:
      image: ghcr.io/clash-lang/nixos-bittide-hardware:2023-02-01

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set CI flags
        run: |
          cp .github/cabal.project.simulation cabal.project.local

      - name: Update Cabal index info
        run: |
          cabal update
          cabal freeze

      - name: Cache
        uses: actions/cache@v3
        with:
          path: |
            ~/.cabal-nix/store

          key: packages-cachebust-3-${{ hashFiles('cabal.project.freeze') }}
          restore-keys: packages-cachebust-3-
          fail-on-cache-miss: true

      - name: Download Firmware Integration Tests
        uses: actions/download-artifact@v3
        with:
          name: firmware-integration-tests

      - name: Extract Firmware Integration Tests
        run: |
          tar -x -f firmware-integration-tests.tar

      - name: Run unittests
        run: |
          cabal run contranomy-sim:unittests


  bittide-tests:
    name: Bittide tests
    runs-on: self-hosted
    defaults:
      run:
        shell: git-nix-shell {0} --pure
    needs: [build, lint]

    container:
      image: ghcr.io/clash-lang/nixos-bittide-hardware:2023-02-01

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set CI flags
        run: |
          cp .github/cabal.project.simulation cabal.project.local

      - name: Update Cabal index info
        run: |
          cabal update
          cabal freeze

      - name: Cache
        uses: actions/cache@v3
        with:
          path: |
            ~/.cabal-nix/store

          key: packages-cachebust-3-${{ hashFiles('cabal.project.freeze') }}
          restore-keys: packages-cachebust-3-
          fail-on-cache-miss: true

      - name: Unittests
        run: |
          # While Hedgehog can fill many cores with "work", it doesn't actually
          # speed up the tests.
          cabal run -- bittide:unittests -j 1 +RTS -N2

      - name: Doctests
        run: |
          cabal run -- bittide:doctests

  firmware-lints:
    name: Firmware Lints
    runs-on: self-hosted
    defaults:
      run:
        shell: git-nix-shell {0} --pure
    container:
      image: ghcr.io/clash-lang/nixos-bittide-hardware:2023-02-01

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Rust formatting
        run: |
          cargo fmt --all -- --check

      - name: Clippy check
        run: |
          cargo clippy --target riscv32imc-unknown-none-elf --all-features


  firmware-unit-tests:
    name: Firmware Unit Tests
    runs-on: self-hosted
    defaults:
      run:
        shell: git-nix-shell {0} --pure
    container:
      image: ghcr.io/clash-lang/nixos-bittide-hardware:2023-02-01

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - uses: actions/cache@v3
        name: Cache
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: cargo-cache-cachebust-2-${{ hashFiles('Cargo.lock') }}

      - name: Running Tests
        run: |
          cargo test --target x86_64-unknown-linux-gnu --all

  firmware-build-examples:
    name: Firmware Build Examples
    runs-on: self-hosted
    defaults:
      run:
        shell: git-nix-shell {0} --pure
    container:
      image: ghcr.io/clash-lang/nixos-bittide-hardware:2023-02-01

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - uses: actions/cache@v3
        name: Cache
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            ./target/
          key: cargo-cache-cachebust-2-${{ hashFiles('Cargo.lock') }}

      - name: Building "hello" Example
        run: cargo build --release
        working-directory: firmware/examples/hello

      - name: Building "fdt-read" Example
        run: cargo build --release
        working-directory: firmware/examples/hello

  firmware-build-integration-tests:
    name: Firmware Build Integration Tests
    runs-on: self-hosted
    defaults:
      run:
        shell: git-nix-shell {0} --pure
    container:
      image: ghcr.io/clash-lang/nixos-bittide-hardware:2023-02-01

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - uses: actions/cache@v3
        name: Cache
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            ./target/
          key: cargo-cache-cachebust-2-${{ hashFiles('Cargo.lock') }}

      - name: Building Firmware Integration Tests
        run: cargo build --release
        working-directory: firmware/tests

      - name: Archive Firmware Integration Tests
        run: |
          cd firmware/tests; sh copy_test_binaries.sh
          cd ../../; tar -c -f firmware-integration-tests.tar firmware-integration-tests/

      - name: Upload Firmware Integration Tests
        uses: actions/upload-artifact@v3
        with:
          name: firmware-integration-tests
          path: firmware-integration-tests.tar

  bittide-instances-doctests:
    name: bittide-instances doctests
    runs-on: self-hosted
    defaults:
      run:
        shell: git-nix-shell {0} --pure
    needs: [build, lint]

    container:
      image: ghcr.io/clash-lang/nixos-bittide-hardware:2023-02-01

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set CI flags
        run: |
          cp .github/cabal.project.formal cabal.project.local

      - name: Update Cabal index info
        run: |
          cabal update
          cabal freeze

      - name: Cache
        uses: actions/cache@v3
        with:
          path: |
            ~/.cabal-nix/store

          key: packages-cachebust-3-${{ hashFiles('cabal.project.freeze') }}
          restore-keys: packages-cachebust-3-
          fail-on-cache-miss: true

      - name: Doctests
        run : |
          cabal run -- bittide-instances:doctests

  bittide-instances-unittests:
    name: bittide-instances unittests
    runs-on: self-hosted
    defaults:
      run:
        shell: git-nix-shell {0} --pure
    needs: [build, lint]

    container:
      image: ghcr.io/clash-lang/nixos-bittide-hardware:2023-02-01

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set CI flags
        run: |
          cp .github/cabal.project.formal cabal.project.local

      - name: Update Cabal index info
        run: |
          cabal update
          cabal freeze

      - name: Cache
        uses: actions/cache@v3
        with:
          path: |
            ~/.cabal-nix/store

          key: packages-cachebust-3-${{ hashFiles('cabal.project.freeze') }}
          restore-keys: packages-cachebust-3-
          fail-on-cache-miss: true

      - name: Unit tests
        run : |
          cabal run -- bittide-instances:unittests

  bittide-instances-hdl-matrix:
    name: bittide-instances synthesis matrix generation
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Generate matrix
        run: |
          if [[ "${{ github.event_name }}" == "schedule" || $(.github/scripts/force_expensive_checks.sh) == "true" ]]; then
            cp .github/synthesis/all.json checks.json
          else
            cp .github/synthesis/staging.json checks.json
          fi

      - name: Set test matrix
        id: set-matrix
        run: |
          echo "check_matrix=$(cat checks.json | tr '\n' ' ')" | tee -a "$GITHUB_OUTPUT"

    outputs:
      check_matrix: ${{ steps.set-matrix.outputs.check_matrix }}

  bittide-instances-hdl:
    name: bittide-instances synthesis
    runs-on: self-hosted
    defaults:
      run:
        # We leave out '--pure', as 'with_vivado.sh' relies on basic Ubuntu
        shell: git-nix-shell {0}
    env:
      SYNTHESIS_PART: xcku040-ffva1156-2-e
      # SYNTHESIS_PART: xcku035-ffva1156-2-e
    needs: [build, lint, bittide-instances-hdl-matrix]

    strategy:
      matrix:
        target: ${{ fromJson(needs.bittide-instances-hdl-matrix.outputs.check_matrix) }}
      fail-fast: false

    container:
      image: ghcr.io/clash-lang/nixos-bittide-hardware:2023-02-01
      volumes:
        - /opt/tools:/opt/tools
      options: --mac-address="6c:5a:b0:6c:13:0b"

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set CI flags
        run: |
          # We use the same flags as the 'build' step to reuse caches. This
          # "simulation" config only sets altopts on the Risc core, which we
          # don't synthesize yet.
          #
          # TODO: Either switch to VexRisc or update cache strategy.
          #
          cp .github/cabal.project.simulation cabal.project.local

      - name: Update Cabal index info
        run: |
          cabal update
          cabal freeze

      - name: Cache
        uses: actions/cache@v3
        with:
          path: |
            ~/.cabal-nix/store

          key: packages-cachebust-3-${{ hashFiles('cabal.project.freeze') }}
          restore-keys: packages-cachebust-3-
          fail-on-cache-miss: true

      - name: HDL generation and synthesis
        run : |
          .github/scripts/with_vivado.sh cabal run -- bittide-instances:shake ${{ matrix.target.top }}:${{ matrix.target.stage }}

      - name: Archive synthesis artifacts
        uses: actions/upload-artifact@v3
        with:
          name: _build
          path: _build
          retention-days: 14

  vex-riscv:
    name: VexRiscv integration
    runs-on: self-hosted
    defaults:
      run:
        shell: git-nix-shell {0} --pure
    needs: [build, lint, vex-riscv-build-integration-tests]

    container:
      image: ghcr.io/clash-lang/nixos-bittide-hardware:2023-02-01

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set CI flags
        run: |
          cp .github/cabal.project.simulation cabal.project.local

      - name: Update Cabal index info
        run: |
          cabal update
          cabal freeze

      - name: Cache
        uses: actions/cache@v3
        with:
          path: |
            ~/.cabal-nix/store

          key: packages-cachebust-3-${{ hashFiles('cabal.project.freeze') }}
          restore-keys: packages-cachebust-3-
          fail-on-cache-miss: true

      - name: Build VexRiscv
        run: |
          cabal build vex-riscv

      - name: Build VexRiscv-test
        run: |
          cabal build vex-test

      - name: Download VexRiscv Integration Tests
        uses: actions/download-artifact@v3
        with:
          name: vex-riscv-test-binaries

      - name: Extract VexRiscv Integration Tests
        run: |
          tar -x -f vex-riscv-test-binaries.tar

      - name: Run unittests
        run: |
          cabal run vex-riscv:unittests

  vex-riscv-build-integration-tests:
    name: VexRiscv build integration tests
    runs-on: self-hosted
    defaults:
      run:
        shell: git-nix-shell {0} --pure
    container:
      image: ghcr.io/clash-lang/nixos-bittide-hardware:2023-02-01

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - uses: actions/cache@v3
        name: Cache
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            ./target/
          key: cargo-cache-cachebust-2-${{ hashFiles('vex-riscv/vex-test-programs/Cargo.lock') }}

      - name: Building VexRiscv Integration Tests (Release)
        run: cargo build --release
        working-directory: vex-riscv/vex-test-programs

      - name: Building VexRiscv Integration Tests (Debug)
        run: cargo build
        working-directory: vex-riscv/vex-test-programs

      - name: Archive Integration Tests
        run: |
          cd vex-riscv; sh bundle_test_binaries.sh

      - name: Upload VexRiscv Integration Tests
        uses: actions/upload-artifact@v3
        with:
          name: vex-riscv-test-binaries
          path: vex-riscv/vex-riscv-test-binaries.tar


  all:
    name: All jobs finished
    if: always()
    needs: [
        bittide-instances-doctests,
        bittide-instances-hdl-matrix,
        bittide-instances-hdl,
        bittide-instances-unittests,
        bittide-tests,
        build,
        contranomy-formal-tests,
        contranomy-hdl,
        contranomy-sim-tests,
        contranomy-tests,
        elastic-buffer-sim-tests,
        elastic-buffer-sim-topologies-matrix,
        elastic-buffer-sim-topologies,
        firmware-build-examples,
        firmware-build-integration-tests,
        firmware-lints,
        firmware-unit-tests,
        license-check,
        lint,
        vex-riscv,
        vex-riscv-build-integration-tests,
      ]
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Check dependencies for failures
        run: |
          # Test all dependencies for success/failure
          set -x
          success="${{ contains(needs.*.result, 'success') }}"
          fail="${{ contains(needs.*.result, 'failure') }}"
          set +x

          # Test whether success/fail variables contain sane values
          if [[ "${success}" != "true" && "${success}" != "false" ]]; then exit 1; fi
          if [[ "${fail}"    != "true" && "${fail}"    != "false" ]]; then exit 1; fi

          # We want to fail if one or more dependencies fail. For safety, we introduce
          # a second check: if no dependencies succeeded something weird is going on.
          if [[ "${fail}" == "true" || "${success}" == "false" ]]; then
            echo "One or more dependency failed, or no dependency succeeded."
            exit 1
          fi

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get -y install python3-yaml
      - name: Check that the 'all' job depends on all other jobs
        run: |
          .github/scripts/all_check.py
